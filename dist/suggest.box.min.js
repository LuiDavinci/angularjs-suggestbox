!function(){"use strict";angular.module("azSuggestBox").directive("azSuggestBox",[function(){return{transclude:!0,restrict:"AE",scope:{listAlias:"@?sbListItemAlias",list:"=sbList",modelAlias:"@?sbModelAlias",model:"=?sbModel",indexes:"=?sbSelectedIndexes",sbMaxSelection:"=?",sbAllowDuplicates:"=?",sbAllowFreeText:"=?",sbAllowAddItem:"=?",sbNewItemField:"@?",sbSearchFieldsRaw:"@?sbSearchFields",sbKeyFieldsRaw:"@?sbKeyFields",sbSelectFirstListItem:"=?",sbBroadcastEventName:"@?",sbSelectedListItemClass:"@?",sbHighlightedListItemClass:"@?",sbCloseListOnSelect:"=?",sbOnSelectionChange:"&?",sbCallbackClickOnItem:"&?"},link:function(e){e.init()},controller:["$document","$rootScope","$scope","$element","$transclude","$timeout",function(e,s,t,l,i,n){t.init=function(){if(void 0===t.list)throw"sb-list attribute must be set";t.listAlias=t.listAlias||"i",t.modelAlias=t.modelAlias||"s",t.indexes=t.indexes||[],t.model=t.model||[],t.sbMaxSelection=t.sbMaxSelection||0,t.sbAllowDuplicates=t.sbAllowDuplicates||!1,t.sbAllowFreeText=t.sbAllowFreeText||!1,t.sbAllowAddItem=t.sbAllowAddItem||!1,t.sbNewItemField=t.sbNewItemField||"name",t.sbSearchFieldsRaw=t.sbSearchFieldsRaw||!1,t.sbKeyFieldsRaw=t.sbKeyFieldsRaw||!1,t.sbSelectFirstListItem=t.sbSelectFirstListItem||!1,t.sbBroadcastEventName=t.sbBroadcastEventName||"azSuggestBoxSelect",t.sbSelectedListItemClass=t.sbSelectedListItemClass||"ng-hide",t.sbHighlightedListItemClass=t.sbHighlightedListItemClass||"sb-list-item-highlight",t.sbCloseListOnSelect=t.sbCloseListOnSelect||!1,t.sbOnSelectionChange=t.sbOnSelectionChange||function(){},t.sbOnSelectionFunc=t.sbOnSelectionFunc||function(){},t.weSentBroadcast=!1,t.sbKeyFieldsRaw?t.sbKeyFields=t.sbKeyFieldsRaw.split(" "):t.sbKeyFields=[],t.sbSearchFieldsRaw?t.sbSearchFields=t.sbSearchFieldsRaw.split(" "):t.sbSearchFields=[],t.closeDropDown=function(){t.isOpen=!1},t.openDropDown=function(){t.isOpen=!0},t.dropDownState=function(){return t.isOpen},t.closeDropDown(),t.sbIsOpen&&t.openDropDown(),t.$watch("isOpen",function(){t.isOpen?l.addClass("open"):l.removeClass("open")}),i(t,function(e,s){l.append(e)}),t.$watchCollection("list",function(){for(var e=0;e<t.list.length;e++)if("object"!=typeof t.list[e])throw"sb-list array items should be objects";if(0==t.sbKeyFields.length&&t.list.length>0)for(var s in t.list[0])t.list[0].hasOwnProperty(s)&&t.sbKeyFields.push(s);if(0==t.sbSearchFields.length&&t.list.length>0)for(var s in t.list[0])t.list[0].hasOwnProperty(s)&&t.sbSearchFields.push(s)}),t.$watchCollection("indexes",function(){if(!t.sbAllowDuplicates){for(var e=0;e<t.list.length;e++)t.unSelectListItem(e);t.indexes.forEach(function(e){t.selectListItem(e)})}for(var s=[],l=0;l<t.model.length;l++)"number"==typeof t.model[l].$listIndex&&(-1==t.indexes.indexOf(t.model[l].$listIndex)?(t.model.splice(l,1),l--):s[t.model[l].$listIndex]=!0);for(var i=0;i<t.indexes.length;i++)s[t.indexes[i]]||(t.model.push(t.list[t.indexes[i]]),t.model[t.model.length-1].$listIndex=t.indexes[i]);t.sbOnSelectionChange()}),t.$on("callback",function(e,s){t.sbCallbackClickOnItem({selectionItemData:s})}),t.$watchCollection("model",function(){for(var e=[],s=0;s<t.indexes.length;s++){for(var l=-1,i=0;i<t.model.length;i++){var n=!0;if(t.sbKeyFields.forEach(function(e){t.list[t.indexes[s]][e]!=t.model[i][e]&&(n=!1)}),n){l=i;break}}-1==l?(t.indexes.splice(s,1),s--):e[l]=!0}for(var o=0;o<t.model.length;o++)if(!e[o])if(t.model[o].$listIndex)t.indexes.push(t.model[o].$listIndex);else{l=-1;for(var a=0;a<t.list.length;a++){n=!0;var d=t.list[a],c=t.model[o];if(t.sbKeyFields.forEach(function(e){d[e]!=c[e]&&(n=!1)}),n){l=a;break}}l>-1?(t.model[o]=t.list[l],t.model[o].$listIndex=l,t.indexes.push(l)):t.model[o].$isNew=!0}}),s[t.sbBroadcastEventName]||(e.on("click",function(e){var l=e.target,i=!1;do{if(l.attributes&&(l.attributes["az-suggest-box"]||l.attributes["sb-trigger-area"])){i=!0;break}l=l.parentNode}while(null!=l);i||s.$broadcast(t.sbBroadcastEventName)}),s[t.sbBroadcastEventName]=!0),t.$on(t.sbBroadcastEventName,function(){t.weSentBroadcast||t.closeDropDown(),t.weSentBroadcast=!1,t.$apply()})}}],controllerAs:"vm"}}])}();
